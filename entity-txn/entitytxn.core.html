<!DOCTYPE html PUBLIC ""
    "">
<html><head><meta charset="UTF-8" /><title>entitytxn.core documentation</title><link rel="stylesheet" type="text/css" href="css/default.css" /><link rel="stylesheet" type="text/css" href="css/highlight.css" /><script type="text/javascript" src="js/highlight.min.js"></script><script type="text/javascript" src="js/jquery.min.js"></script><script type="text/javascript" src="js/page_effects.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a></h2><h1><a href="index.html"><span class="project-title"><span class="project-name">Entity-txn</span> <span class="project-version">0.1.3</span></span></a></h1></div><div class="sidebar primary"><h3 class="no-link"><span class="inner">Project</span></h3><ul class="index-link"><li class="depth-1 "><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Topics</span></h3><ul><li class="depth-1 "><a href="intro.html"><div class="inner"><span>entity-txn</span></div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>entitytxn</span></div></div></li><li class="depth-2 branch"><a href="entitytxn.aggregate.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>aggregate</span></div></a></li><li class="depth-2 branch current"><a href="entitytxn.core.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>core</span></div></a></li><li class="depth-2 branch"><a href="entitytxn.entity.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>entity</span></div></a></li><li class="depth-2 branch"><a href="entitytxn.lock.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>lock</span></div></a></li><li class="depth-2"><a href="entitytxn.protocols.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>protocols</span></div></a></li></ul></div><div class="sidebar secondary"><h3><a href="#top"><span class="inner">Public Vars</span></a></h3><ul><li class="depth-1"><a href="entitytxn.core.html#var-abort"><div class="inner"><span>abort</span></div></a></li><li class="depth-1"><a href="entitytxn.core.html#var-assoc"><div class="inner"><span>assoc</span></div></a></li><li class="depth-1"><a href="entitytxn.core.html#var-commit"><div class="inner"><span>commit</span></div></a></li><li class="depth-1"><a href="entitytxn.core.html#var-create"><div class="inner"><span>create</span></div></a></li><li class="depth-1"><a href="entitytxn.core.html#var-delete"><div class="inner"><span>delete</span></div></a></li><li class="depth-1"><a href="entitytxn.core.html#var-in-creation.3F"><div class="inner"><span>in-creation?</span></div></a></li><li class="depth-1"><a href="entitytxn.core.html#var-in-deletion.3F"><div class="inner"><span>in-deletion?</span></div></a></li><li class="depth-1"><a href="entitytxn.core.html#var-in-transaction"><div class="inner"><span>in-transaction</span></div></a></li><li class="depth-1"><a href="entitytxn.core.html#var-joined.3F"><div class="inner"><span>joined?</span></div></a></li><li class="depth-1"><a href="entitytxn.core.html#var-lock.21"><div class="inner"><span>lock!</span></div></a></li><li class="depth-1"><a href="entitytxn.core.html#var-make-new-instance"><div class="inner"><span>make-new-instance</span></div></a></li><li class="depth-1"><a href="entitytxn.core.html#var-managed.3F"><div class="inner"><span>managed?</span></div></a></li><li class="depth-1"><a href="entitytxn.core.html#var-merge"><div class="inner"><span>merge</span></div></a></li><li class="depth-1"><a href="entitytxn.core.html#var-read-instance"><div class="inner"><span>read-instance</span></div></a></li><li class="depth-1"><a href="entitytxn.core.html#var-set-transaction-defaults"><div class="inner"><span>set-transaction-defaults</span></div></a></li><li class="depth-1"><a href="entitytxn.core.html#var-write-txn-state"><div class="inner"><span>write-txn-state</span></div></a></li></ul></div><div class="namespace-docs" id="content"><h1 class="anchor" id="top">entitytxn.core</h1><div class="doc"><pre class="plaintext">Transaction state management
</pre></div><div class="public anchor" id="var-abort"><h3>abort</h3><div class="usage"><code>(abort)</code></div><div class="doc"><pre class="plaintext">Abort the transaction. Transaction state is discarded and any :on-abort function
is called. Further use of the transaction is not permitted.

abort is called if the transaction body incurs an exception.</pre></div><div class="src-link"><a href="https://github.com/inqwell/entity-txn/blob/master/src/entitytxn/core.clj#L402">view source</a></div></div><div class="public anchor" id="var-assoc"><h3>assoc</h3><div class="usage"><code>(assoc map key val)</code><code>(assoc map key val &amp; kvs)</code></div><div class="doc"><pre class="plaintext">As for clojure.core/assoc, however if the target map is managed
track its mutation in the transaction. If the map is not
managed the transaction state is unaffected.

The :assoc function in the transaction settings is used to perform
the map operation. Consider using typeops/assoc to maintain value types
and a fixed key set.</pre></div><div class="src-link"><a href="https://github.com/inqwell/entity-txn/blob/master/src/entitytxn/core.clj#L491">view source</a></div></div><div class="public anchor" id="var-commit"><h3>commit</h3><div class="usage"><code>(commit)</code></div><div class="doc"><pre class="plaintext">Commit the current transaction. Each instance joined for mutate will have
TxnEvents.mutate-entity called, passing the original and current values. If any instances
are entered into the transaction by the actions of the mutate calls,
these will in turn be committed on subsequent passes. When all participants have been
committed any :on-commit function will be called, passing all participants. This function
cannot further affect transaction state.</pre></div><div class="src-link"><a href="https://github.com/inqwell/entity-txn/blob/master/src/entitytxn/core.clj#L371">view source</a></div></div><div class="public anchor" id="var-create"><h3>create</h3><div class="usage"><code>(create instance)</code></div><div class="doc"><pre class="plaintext">Initialise the instance via TxnEvents.create-entity and join the result into the
transaction for creation. If the instance is already managed or its identity is already
joined in this or a parent transaction, this is an error.
Returns the value being created in the transaction.</pre></div><div class="src-link"><a href="https://github.com/inqwell/entity-txn/blob/master/src/entitytxn/core.clj#L529">view source</a></div></div><div class="public anchor" id="var-delete"><h3>delete</h3><div class="usage"><code>(delete val)</code></div><div class="doc"><pre class="plaintext">Join the given value into the transaction for deletion. If the
value is not managed or already scheduled for deletion this is an error.
If the value has been previously created it is removed from the transaction.
When successful calls TxnEvents.destroy-entity and returns true. Throws
otherwise.</pre></div><div class="src-link"><a href="https://github.com/inqwell/entity-txn/blob/master/src/entitytxn/core.clj#L563">view source</a></div></div><div class="public anchor" id="var-in-creation.3F"><h3>in-creation?</h3><div class="usage"><code>(in-creation? instance)</code></div><div class="doc"><pre class="plaintext">Return the instance if the given instance (or identity) is marked for
creation in the current or any parent transaction. Falsy otherwise.</pre></div><div class="src-link"><a href="https://github.com/inqwell/entity-txn/blob/master/src/entitytxn/core.clj#L455">view source</a></div></div><div class="public anchor" id="var-in-deletion.3F"><h3>in-deletion?</h3><div class="usage"><code>(in-deletion? instance)</code></div><div class="doc"><pre class="plaintext">Return the instance, as truthy true if the given instance (or identity) is
marked for deletion in the current or any parent transaction. Falsy otherwise.</pre></div><div class="src-link"><a href="https://github.com/inqwell/entity-txn/blob/master/src/entitytxn/core.clj#L449">view source</a></div></div><div class="public anchor" id="var-in-transaction"><h3>in-transaction</h3><h4 class="type">macro</h4><div class="usage"><code>(in-transaction args &amp; body)</code></div><div class="doc"><pre class="plaintext">Opens a new transaction with optional arguments and runs the body in it, committing
when the transaction closes. To specify args, pass a map which will be merged with
any established by set-transaction-defaults, for example to supply a specific :on-commit
function. Code runs in an implicit do, with any :on-start function called first.

If an exception occurs, abort is called and the exception rethrown, otherwise
commit is called. Any :on-end function is always run. Returns nil.</pre></div><div class="src-link"><a href="https://github.com/inqwell/entity-txn/blob/master/src/entitytxn/core.clj#L414">view source</a></div></div><div class="public anchor" id="var-joined.3F"><h3>joined?</h3><div class="usage"><code>(joined? instance)</code></div><div class="doc"><pre class="plaintext">Return true if the given instance (or identity) is joined in some way in
the current or any parent transaction.</pre></div><div class="src-link"><a href="https://github.com/inqwell/entity-txn/blob/master/src/entitytxn/core.clj#L250">view source</a></div></div><div class="public anchor" id="var-lock.21"><h3>lock!</h3><div class="usage"><code>(lock! val)</code><code>(lock! val timeout)</code></div><div class="doc"><pre class="plaintext">Attempt to lock the given value obtaining the lock if it is available
or waiting the specified timeout in milliseconds otherwise. A timeout of
zero means unwilling to wait; negative means wait indefinitely.

Locks taken out become part of the current transaction's state. Locks held
in the current transaction are released automatically when the transaction
closes, and in reverse order of locking.

Returns the value as truthy if the lock was obtained, throws otherwise.</pre></div><div class="src-link"><a href="https://github.com/inqwell/entity-txn/blob/master/src/entitytxn/core.clj#L74">view source</a></div></div><div class="public anchor" id="var-make-new-instance"><h3>make-new-instance</h3><div class="usage"><code>(make-new-instance &amp; args)</code></div><div class="doc"><pre class="plaintext">Makes a new, as yet unmanaged, instance of a domain type according to the
given arguments, by calling TxnEvents.new-instance. The args are appropriate to
the underlying system of domain types. Does not call TxnEvents.create-entity
until create is called.</pre></div><div class="src-link"><a href="https://github.com/inqwell/entity-txn/blob/master/src/entitytxn/core.clj#L520">view source</a></div></div><div class="public anchor" id="var-managed.3F"><h3>managed?</h3><div class="usage"><code>(managed? instance)</code></div><div class="doc"><pre class="plaintext">Return whether an instance is managed and therefore able
to participate in a transaction for mutate/delete. An
instance that is unmanaged can be marked for creation in the
transaction.</pre></div><div class="src-link"><a href="https://github.com/inqwell/entity-txn/blob/master/src/entitytxn/core.clj#L107">view source</a></div></div><div class="public anchor" id="var-merge"><h3>merge</h3><div class="usage"><code>(merge &amp; maps)</code></div><div class="doc"><pre class="plaintext">As for clojure.core/merge, however if the target map is managed
track its state in the transaction. If the map is notmanaged the
transaction state is unaffected.

The :merge function in the transaction settings is used to perform
the map operation. Consider using typeops/assoc to maintain value types
and a fixed key set.</pre></div><div class="src-link"><a href="https://github.com/inqwell/entity-txn/blob/master/src/entitytxn/core.clj#L506">view source</a></div></div><div class="public anchor" id="var-read-instance"><h3>read-instance</h3><div class="usage"><code>(read-instance key-val &amp; args)</code></div><div class="doc"><pre class="plaintext">Read one or more instances via TxnEvents.read-entity. Within
a transaction, for any values returned, the following occurs:
  1) If the value is being deleted, do not return it (or if a
     non-unique key, remove it from the sequence)
  2) If the value is being mutated, return the current value
  3) Return the value as-is, marked as managed.
Values in creation are not returned as there is no connection
with the underlying persistence logic, however such values
can be queried for participation with in-creation?.

Any args are passed to the underlying implementation, so must
be compatible with that.

If no transaction is running the result(s) from the TxnEvents.read-entity
is returned unmanaged. Instance(s) cannot take part in a transaction when
acquired outside it.</pre></div><div class="src-link"><a href="https://github.com/inqwell/entity-txn/blob/master/src/entitytxn/core.clj#L461">view source</a></div></div><div class="public anchor" id="var-set-transaction-defaults"><h3>set-transaction-defaults</h3><div class="usage"><code>(set-transaction-defaults &amp; defaults)</code></div><div class="doc"><div class="markdown"><p>Set up defaults to be used in transactions and nested transactions. This function will typically be called from an application’s state management setup</p>
<ul>
  <li>`:events connect transaction state to type and io system (defaults to none)</li>
  <li><code>:assoc</code> how to assoc maps (defaults to clojure.core/assoc)</li>
  <li><code>:merge</code> how to merge maps (defaults to clojure.core/merge)</li>
  <li><code>:on-commit</code> function accepting two arguments <code>[participants actions]</code> to call when the  transaction commits.</li>
  <li><code>:on-abort</code> a function of zero arguments called when transaction aborts (exception or explicit)</li>
  <li><code>:on-start</code> a function of zero arguments called before transaction body is executed</li>
  <li><code>:on-end</code> function of zero arguments called after transaction commits or aborts</li>
</ul></div></div><div class="src-link"><a href="https://github.com/inqwell/entity-txn/blob/master/src/entitytxn/core.clj#L13">view source</a></div></div><div class="public anchor" id="var-write-txn-state"><h3>write-txn-state</h3><div class="usage"><code>(write-txn-state participants)</code></div><div class="doc"><pre class="plaintext">Write the values contained in the current transaction to backing store
via TxnEvents.write-entity for create and mutate and TxnEvents.delete-entity
for delete. This is a convenience function that clients
can call via their :on-commit action, for example, within a transaction
binding for the particular backing store.</pre></div><div class="src-link"><a href="https://github.com/inqwell/entity-txn/blob/master/src/entitytxn/core.clj#L345">view source</a></div></div></div></body></html>