<!DOCTYPE html PUBLIC ""
    "">
<html><head><meta charset="UTF-8" /><title>Introduction to typeops</title><link rel="stylesheet" type="text/css" href="css/default.css" /><link rel="stylesheet" type="text/css" href="css/highlight.css" /><script type="text/javascript" src="js/highlight.min.js"></script><script type="text/javascript" src="js/jquery.min.js"></script><script type="text/javascript" src="js/page_effects.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a></h2><h1><a href="index.html"><span class="project-title"><span class="project-name">Typeops</span> <span class="project-version">0.1.2</span></span></a></h1></div><div class="sidebar primary"><h3 class="no-link"><span class="inner">Project</span></h3><ul class="index-link"><li class="depth-1 "><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Topics</span></h3><ul><li class="depth-1  current"><a href="intro.html"><div class="inner"><span>Introduction to typeops</span></div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>typeops</span></div></div></li><li class="depth-2 branch"><a href="typeops.assign.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>assign</span></div></a></li><li class="depth-2"><a href="typeops.core.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>core</span></div></a></li></ul></div><div class="document" id="content"><div class="doc"><div class="markdown"><h1><a href="#introduction-to-typeops" name="introduction-to-typeops"></a>Introduction to typeops</h1>
<p>Alternative type outcomes for arithmetic in Clojure.</p>
<p><a href="http://clojars.org/typeops"><img src="http://clojars.org/typeops/latest-version.svg" alt="Clojars Project" /></a></p>
<p><code>[typeops "0.1.2"]</code></p>
<ul>
  <li>
  <p>In Clojure, functions are agnostic about argument types, yet the host platform is not and likely neither is your database.</p></li>
  <li>
  <p>If you are writing a calculation engine then in many cases floating point types are unsuitable - inaccuracies will accumulate making results unpredictable.</p></li>
  <li>
  <p>Value type systems and how the types combine are a policy decision. While Clojure supports integer and floating point types, and mostly makes precise decimal usage transparent, the way these combine as operands in the arithmetic functions may not be to your liking.</p></li>
</ul>
<p>OK:</p>
<pre><code class="clojure">(/ 123.456M 3)
=&gt; 41.152M
</code></pre>
<p>Not OK:</p>
<pre><code class="clojure">(/ 123.457M 3)
ArithmeticException Non-terminating decimal expansion;
no exact representable decimal result.
java.math.BigDecimal.divide (BigDecimal.java:1690)
</code></pre>
<p>We can get round this using <code>with-precision</code> :</p>
<pre><code class="clojure">(with-precision 5
  (/ 123.457M 3))
=&gt; 41.152M
</code></pre>
<p>but this taints the code, forcing us to be aware of the underlying types, and what precision do we choose if our interest is accuracy?</p>
<p>If you are using <code>decimal</code> it doesn’t make sense to allow these to combine with floating point:</p>
<pre><code class="clojure">(* 123.457M 3.142)
=&gt; 387.90189399999997
</code></pre>
<p>If you want to avoid <code>ratio</code> preferring integer arithmetic, again, you have to be explicit:</p>
<pre><code class="clojure">(/ 4 3)
=&gt; 4/3

(quot 4 3)
=&gt; 1
</code></pre>
<p>Typeops does the following for <code>+</code> <code>-</code> <code>*</code> and <code>/</code> :</p>
<ul>
  <li>
  <p>Integer arithmetic gives a (truncated) integer result</p></li>
  <li>
  <p>Intermediate results do not lose accuracy</p></li>
  <li>
  <p>decimals cannot combine with floating point</p></li>
</ul>
<h2><a href="#assign" name="assign"></a>“assign”</h2>
<p>If you are modelling domain types it is useful to “assign” fields according to their underlying type and accuracy, rather than say relying on your database to do this for you:</p>
<pre><code class="clojure">(def m
{:Integer  0,
 :Decimal2 0.00M,
 :Short    0,
 :Decimal  0E-15M,
 :Float    0.0,
 :Long     1,
 :Byte     0,
 :Double   0.0,
 :String   ""})

(assoc m :Decimal2 2.7182818M)
=&gt; {:Integer 0,
    :Decimal2 2.72M,
    :Short 0,
    :Decimal 0E-15M,
    :Float 0.0,
    :Long 1,
    :Byte 0,
    :Double 0.0,
    :String ""}
</code></pre>
<h3><a href="#nil" name="nil"></a>nil</h3>
<p>If your domain model permits <code>NULL</code> values you can represent these as <code>nil</code> in Clojure. This destroys the type information however if a map has meta data:</p>
<pre><code class="clojure">(meta m)
=&gt; {:proto {:Integer 0, :Decimal2 0.00M, ...}}
</code></pre>
<p>then “assigning” away from <code>nil</code> will use the corresponding field in the <code>:proto</code> map to align the type.</p>
<h3><a href="#non-numerics" name="non-numerics"></a>Non-numerics</h3>
<p>For non-numeric fields typeops will use any :proto to keep map values as their intended type. Attempting to “assign” something that is false for <code>instance?</code> results in an exception</p>
<h3><a href="#error-handling" name="error-handling"></a>Error Handling</h3>
<p>Typeops uses dynamic vars to help with error handling and debugging. Bind <code>*debug*</code> to <code>true</code> to carry information about type-incompatible <code>assoc</code> operations out via the exception.</p>
<pre><code class="clojure">(binding [typeops.core/*debug* true]
     (assoc m :Integer "foo"))

=&gt; ExceptionInfo Incompatible type for operation: class java.lang.String  clojure.core/ex-info (core.clj:4617)
*e

=&gt; #error{:cause "Incompatible type for operation: class java.lang.String",
          :data {:map {:Integer 0,
                       :Decimal2 0.00M,
                       :Short 0,
                       :Decimal 0E-15M,
                       :Float 0.0,
                       :Date #inst"2019-03-28T17:14:27.816-00:00",
                       :Long 1,
                       :Byte 0,
                       :Double 0.0,
                       :String ""},
                 :key :Integer,
                 :val "foo",
                 :cur 0},
          :via [{:type clojure.lang.ExceptionInfo,
                 :message "Incompatible type for operation: class java.lang.String"
                   .
                   .
</code></pre>
<p>Bind <code>*warn-on-absent-key*</code> to a function of two arguments <code>(fn [m k] ...)</code> which will be called when <code>assoc</code> puts a key into a map that wasn’t there before.</p>
<pre><code>(binding [typeops.assign/*warn-on-absent-key*
          (fn [m k]
            (println k "Boo!"))]
  (assoc m :Absent "foo"))
:Absent Boo!
=&gt; {:Absent "foo",
    :Integer 0,
    :Decimal2 0.00M,
    :Short 0,
    :Decimal 0E-15M,
    :Float 0.0,
    :Date #inst"2019-03-28T17:14:27.816-00:00",
    :Long 1,
    :Byte 0,
    :Double 0.0,
    :String ""}
</code></pre>
<h2><a href="#usage" name="usage"></a>Usage</h2>
<h3><a href="#per-namespace" name="per-namespace"></a>Per Namespace</h3>
<pre><code class="clojure">(ns myns
  (:refer-clojure :exclude [+ - * / assoc merge])
  (:require [typeops.core :refer :all])
  (:require [typeops.assign :refer :all]))

(+ 3.142M 2.7182818M)
=&gt; 5.8602818M

(- 3.142M 2.7182818M 3.142M)
=&gt; -2.7182818M

(* 3.142M 2.7182818M 3.142M)
=&gt; 26.8353237278152M

(/ 3.142M 2.7182818M 0.1234M)
=&gt; 9.368M

(assoc my-map k v ... ks vs)  ; assoc preserves type and precision
(assign my-map k v ... ks vs) ; same as above

</code></pre>
<h3><a href="#globally" name="globally"></a>Globally</h3>
<p>Call the function <code>init-global!</code> somewhere in your system start up to alter the vars <code>+</code> <code>-</code> <code>*</code> and <code>/</code> in <code>clojure.core</code>.</p>
<h2><a href="#license" name="license"></a>License</h2>
<p>Copyright © 2018-2019 Inqwell Ltd</p>
<p>Distributed under the Eclipse Public License either version 1.0 or (at your option) any later version.</p></div></div></div></body></html>